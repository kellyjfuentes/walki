<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WALKi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Simple scrollbar styling for a better look */
      ::-webkit-scrollbar {
        width: 5px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-fadeIn {
        animation: fadeIn 1s ease-in-out;
      }
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .animate-slideUp {
        animation: slideUp 0.5s ease-out forwards;
      }
    </style>
</head>
<body class="bg-gray-200">

    <div id="root">
        <!-- App is rendered here by JS -->
    </div>
    
    <script>
      // --- DATA ---
      const mockDestinations = [
        { id: 1, name: "Pico del Águila", description: "Lorem ipsum dolor sit amet consectetur adipiscing elit, hendrerit a porta fermentum lacus.", altitude: 2829, difficulty: "Avanzada", category: "Roca", imageUrl: "https://picsum.photos/400/300?image=106", latitude: 40.85, longitude: -3.85 },
        { id: 2, name: "Sendero del Bosque", description: "Hac magnis class metus risus per dapibus iaculis vestibulum nec.", altitude: 1100, difficulty: "Principiante", category: "Tierra", imageUrl: "https://picsum.photos/400/300?image=119", latitude: 40.75, longitude: -3.95 },
        { id: 3, name: "Glaciar Escondido", description: "Porta fermentum lacus, hac magnis class metus risus per dapibus iaculis vestibulum nec.", altitude: 3500, difficulty: "Avanzada", category: "Nieve", imageUrl: "https://picsum.photos/400/300?image=25", latitude: 41.05, longitude: -3.65 },
        { id: 4, name: "Cañón del Río Verde", description: "Lorem ipsum dolor sit amet consectetur adipiscing elit, hendrerit a porta.", altitude: 850, difficulty: "Intermedio", category: "Acuático", imageUrl: "https://picsum.photos/400/300?image=1015", latitude: 40.65, longitude: -3.55 },
        { id: 5, name: "Ruta de las Cascadas", description: "Metus risus per dapibus iaculis vestibulum nec.", altitude: 1300, difficulty: "Principiante", category: "Tierra", imageUrl: "https://picsum.photos/400/300?image=1037", latitude: 40.55, longitude: -4.05 },
      ];

      const onboardingImages = [
        "https://picsum.photos/800/600?image=1043",
        "https://picsum.photos/800/600?image=1050",
        "https://picsum.photos/800/600?image=200",
        "https://picsum.photos/800/600?image=10"
      ];
      
      const categories = ['Todos', 'Tierra', 'Roca', 'Nieve', 'Acuático'];

      // --- STATE ---
      let appState = 'splash'; // 'splash', 'onboarding', 'loggedIn'
      let activeScreen = 'Inicio'; // 'Inicio', 'Explorar', etc.
      let onboardingState = {
          currentImage: 0,
          authMode: 'none' // 'none', 'login', 'register'
      };
      let userLocation = null;
      let locationError = null;

      // --- ICONS (as functions returning SVG strings) ---
      const WalkiLogo = (className) => `<svg class="${className}" viewBox="0 0 260 60" xmlns="http://www.w3.org/2000/svg" aria-labelledby="walki-logo-title"><title id="walki-logo-title">WALKi Logo</title><text x="0" y="45" fontFamily="Arial, sans-serif" fontSize="60" fontWeight="bold" fill="currentColor"><tspan>WA</tspan><tspan x="180" dy="0">Ki</tspan></text><g transform="translate(105, 5) scale(0.12)"><path fill="currentColor" d="M264.44,309.86,220,285.33V181.71L188,165.71V128.29l32-16v-16L188,72.86V0h32V68.29l104,52ZM220,93.14l12.89,6.45-32.44,16.22-12.89-6.45ZM116,336H0V304H53.15L0,229.71,22.29,216,88,304h28Z"/><path fill="currentColor" d="M116,400H0V368H116Z"/></g></svg>`;
      const navIconProps = `class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"`;
      const HomeIcon = () => `<svg ${navIconProps}><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`;
      const ExploreIcon = () => `<svg ${navIconProps}><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 10h6" /></svg>`;
      const MedalIcon = () => `<svg ${navIconProps}><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
      const CommunityIcon = () => `<svg ${navIconProps}><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`;
      const ProfileIcon = () => `<svg ${navIconProps}><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
      const miniIconProps = (className) => `class="${className}" fill="none" viewBox="0 0 24 24" stroke="currentColor"`;
      const SearchIcon = (c) => `<svg ${miniIconProps(c)}><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`;
      const MapPinIcon = (c) => `<svg ${miniIconProps(c)}><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
      const RouteIcon = (c) => `<svg ${miniIconProps(c)}><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>`;
      const MountainIcon = (c) => `<svg ${miniIconProps(c)}><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M3 10l6-6 4 4 6-6" /></svg>`;
      const ClockIcon = (c) => `<svg ${miniIconProps(c)}><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
      const BootIcon = (c) => `<div class="p-2 bg-green-700 rounded-lg ${c}"><svg viewBox="0 0 270 400" xmlns="http://www.w3.org/2000/svg" class="w-full h-full" fill="white" aria-label="WALKi boot icon"><path d="M264.44,309.86,220,285.33V181.71L188,165.71V128.29l32-16v-16L188,72.86V0h32V68.29l104,52ZM220,93.14l12.89,6.45-32.44,16.22-12.89-6.45ZM116,336H0V304H53.15L0,229.71,22.29,216,88,304h28Z"/><path d="M116,400H0V368H116Z"/></svg></div>`;

      // --- TEMPLATES (as functions returning HTML strings) ---
      const SplashScreen = () => `
        <div id="splash-screen" class="flex flex-col items-center justify-center h-screen bg-white animate-fadeIn">
          <div class="text-center">
            ${WalkiLogo("w-48 h-auto text-green-700 mx-auto")}
            <p class="text-gray-600 mt-2 text-lg">Tu compañero de montaña</p>
          </div>
        </div>`;

      const OnboardingScreen = () => `
        <div id="onboarding-screen" class="min-h-screen bg-gray-50 flex flex-col" style="display: none;">
          <div class="relative h-1/2 w-full">
            ${onboardingImages.map((img, index) => `
              <img 
                src="${img}" 
                alt="Hiking scenery"
                class="onboarding-image absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-1000 ${index === onboardingState.currentImage ? 'opacity-100' : 'opacity-0'}"
              />`).join('')}
            <div class="absolute inset-0 bg-black bg-opacity-20"></div>
            <div id="onboarding-dots" class="absolute bottom-4 left-0 right-0 flex justify-center space-x-2">
              ${onboardingImages.map((_, index) => `<div class="w-2.5 h-2.5 rounded-full transition-all ${index === onboardingState.currentImage ? 'bg-white scale-125' : 'bg-white/50'}"></div>`).join('')}
            </div>
          </div>
          <div class="flex-grow flex flex-col items-center justify-center p-6 -mt-10">
            <div class="relative z-10 w-full max-w-sm text-center">
              ${WalkiLogo("w-40 h-auto text-green-700 mx-auto")}
              <p class="text-gray-600 mt-1 text-md">Tu compañero de montaña</p>
              <div id="auth-container"></div>
            </div>
          </div>
        </div>`;
      
      const OnboardingForm = () => {
          if (onboardingState.authMode === 'none') return `
            <div class="mt-8 space-y-4 animate-fadeIn">
                <button id="show-login-btn" class="w-full py-3 bg-green-700 text-white font-bold rounded-full hover:bg-green-800 transition-transform transform hover:scale-105">Iniciar sesión</button>
                <button id="show-register-btn" class="w-full py-3 bg-white text-green-700 font-bold border-2 border-green-700 rounded-full hover:bg-green-50 transition-transform transform hover:scale-105">Regístrate</button>
            </div>
          `;

          const commonInputClasses = "w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 transition-all";
          const commonButtonClasses = "w-full py-3 bg-green-700 text-white font-bold rounded-full hover:bg-green-800 transition-transform transform hover:scale-105";

          return `
            <div class="w-full mt-8 p-6 bg-white rounded-3xl shadow-lg animate-slideUp">
              <div class="flex justify-around mb-6 border-b">
                <button id="tab-login-btn" class="w-1/2 pb-3 font-semibold transition-colors ${onboardingState.authMode === 'login' ? 'text-green-700 border-b-2 border-green-700' : 'text-gray-500'}">Iniciar sesión</button>
                <button id="tab-register-btn" class="w-1/2 pb-3 font-semibold transition-colors ${onboardingState.authMode === 'register' ? 'text-green-700 border-b-2 border-green-700' : 'text-gray-500'}">Regístrate</button>
              </div>
              ${onboardingState.authMode === 'login' ? `
                <form id="login-form" class="space-y-4">
                  <h2 class="text-xl font-bold text-center text-gray-800 mb-4">¡Bienvenido de nuevo!</h2>
                  <input type="email" placeholder="Correo electrónico" class="${commonInputClasses}" required />
                  <input type="password" placeholder="Contraseña" class="${commonInputClasses}" required />
                  <button type="submit" class="${commonButtonClasses}">Iniciar sesión</button>
                </form>
              ` : `
                <form id="register-form" class="space-y-4">
                  <h2 class="text-xl font-bold text-center text-gray-800 mb-4">Crea una cuenta</h2>
                  <input type="text" placeholder="Nombre de usuario" class="${commonInputClasses}" required />
                  <input type="email" placeholder="Correo electrónico" class="${commonInputClasses}" required />
                  <input type="password" placeholder="Crear contraseña" class="${commonInputClasses}" required />
                  <button type="submit" class="${commonButtonClasses}">Registrarse</button>
                </form>
              `}
              <div class="text-center my-4 text-gray-400">o</div>
              <div class="flex justify-center space-x-4">
                <button class="w-12 h-12 bg-gray-200 rounded-full"></button>
                <button class="w-12 h-12 bg-gray-200 rounded-full"></button>
                <button class="w-12 h-12 bg-gray-200 rounded-full"></button>
              </div>
            </div>`;
      };
      
      const ProfileScreen = () => `
        <div id="screen-Inicio" class="p-4 space-y-6">
            <header class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">¡Hola, Diego!</h1>
                    <p class="text-gray-500">¿Listo para tu próxima aventura?</p>
                </div>
                <div class="w-16 h-16 bg-gray-200 rounded-full"></div>
            </header>
            <div class="p-4 bg-white rounded-2xl shadow-sm">
                <div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-800">Nivel 5</span><span class="text-xs text-gray-500">4000 / 5000 XP</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-600 h-2.5 rounded-full" style="width: 80%;"></div></div>
                <p class="text-xs text-center text-gray-500 mt-2">1000 XP para el siguiente nivel</p>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1 p-4 bg-white rounded-2xl shadow-sm flex flex-col items-center justify-center text-center"><div class="mb-2 text-green-700">${RouteIcon("w-6 h-6")}</div><p class="text-xl font-bold text-gray-800">12</p><p class="text-xs text-gray-500">Rutas</p></div>
                <div class="flex-1 p-4 bg-white rounded-2xl shadow-sm flex flex-col items-center justify-center text-center"><div class="mb-2 text-green-700">${MountainIcon("w-6 h-6")}</div><p class="text-xl font-bold text-gray-800">103 km</p><p class="text-xs text-gray-500">Altitud</p></div>
                <div class="flex-1 p-4 bg-white rounded-2xl shadow-sm flex flex-col items-center justify-center text-center"><div class="mb-2 text-green-700">${ClockIcon("w-6 h-6")}</div><p class="text-xl font-bold text-gray-800">182 h</p><p class="text-xs text-gray-500">Tiempo</p></div>
            </div>
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-gray-800">Última Actividad</h3>
                <div class="bg-white rounded-2xl shadow-sm flex p-3 items-center space-x-4">
                    <img src="https://picsum.photos/200/200?image=106" alt="Pico del Águila" class="w-20 h-20 rounded-xl object-cover" />
                    <div><h4 class="font-bold text-gray-900">Pico del Águila</h4><p class="text-sm text-gray-500 mt-1">Lorem ipsum dolor sit amet consectetur adipiscing elit, hendrerit a porta fermentum lacus.</p><p class="text-xs text-gray-400 mt-2">Hace 2 días</p></div>
                </div>
            </div>
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-gray-800">Reto Semanal</h3>
                <div class="bg-white rounded-2xl shadow-sm p-4"><p class="font-semibold text-gray-800">Conquistador de Alturas</p><p class="text-sm text-gray-500">Completa 3 rutas de más 1500m</p><div class="flex justify-between items-center mt-3 mb-1"><span class="text-xs text-gray-500">Progreso</span><span class="text-xs font-semibold text-gray-600">2/3</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-yellow-500 h-2 rounded-full" style="width: 66.6%;"></div></div></div>
            </div>
            <div class="pt-4"><button class="w-full py-4 bg-green-700 text-white font-bold rounded-full hover:bg-green-800 transition-transform transform hover:scale-105 shadow-lg">+ Nueva Actividad</button></div>
        </div>
      `;

      const ExploreScreen = () => `
        <div id="screen-Explorar" class="p-4 space-y-6" style="display: none;">
            <header class="flex items-center justify-start">${BootIcon("w-10 h-10")}</header>
            <div class="relative"><input type="text" placeholder="Buscar destinos..." class="w-full pl-10 pr-4 py-3 bg-gray-100 border border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" />${SearchIcon("absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400")}</div>
            <div id="map-widget" class="p-4 bg-white rounded-2xl shadow-sm text-center"></div>
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-3">Categorías</h3>
                <div id="categories-container" class="flex space-x-2 overflow-x-auto pb-2"></div>
            </div>
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-3">Destinos</h3>
                <div id="destinations-list" class="space-y-4"></div>
            </div>
        </div>
      `;
      
      const MainApp = () => `
        <div id="app-container" class="bg-gray-50 min-h-screen font-sans w-full max-w-md mx-auto shadow-lg relative pb-20" style="display: none;">
            <main class="overflow-y-auto">
              ${ProfileScreen()}
              ${ExploreScreen()}
              <div id="screen-Medallas" class="p-4 text-center" style="display: none;">Medallas - Próximamente</div>
              <div id="screen-Comunidad" class="p-4 text-center" style="display: none;">Comunidad - Próximamente</div>
              <div id="screen-Perfil" class="p-4 space-y-6" style="display: none;">${ProfileScreen().replace('id="screen-Inicio"','')}</div>
            </main>
            <div class="fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-white border-t border-gray-200 shadow-t-lg">
                <div id="bottom-nav" class="flex justify-around"></div>
            </div>
        </div>
      `;

      // --- RENDER FUNCTIONS ---
      const root = document.getElementById('root');

      function render() {
        if (appState === 'splash') {
          root.innerHTML = SplashScreen();
        } else if (appState === 'onboarding') {
          root.innerHTML = OnboardingScreen();
          renderOnboardingForm();
        } else if (appState === 'loggedIn') {
          root.innerHTML = MainApp();
          renderBottomNav();
          renderActiveScreen();
          addNavListeners();
        }
      }
      
      function renderOnboardingForm() {
        const container = document.getElementById('auth-container');
        if (container) {
          container.innerHTML = OnboardingForm();
          addOnboardingListeners();
        }
      }

      function renderActiveScreen() {
        ['Inicio', 'Explorar', 'Medallas', 'Comunidad', 'Perfil'].forEach(screen => {
            const el = document.getElementById(`screen-${screen}`);
            if (el) el.style.display = screen === activeScreen ? 'block' : 'none';
        });

        if (activeScreen === 'Explorar') {
            renderExploreContent();
        }
      }
      
      function renderBottomNav() {
        const navItems = [
          { label: 'Inicio', icon: HomeIcon() }, { label: 'Explorar', icon: ExploreIcon() },
          { label: 'Medallas', icon: MedalIcon() }, { label: 'Comunidad', icon: CommunityIcon() },
          { label: 'Perfil', icon: ProfileIcon() },
        ];
        const navContainer = document.getElementById('bottom-nav');
        if (navContainer) {
          navContainer.innerHTML = navItems.map(item => `
            <button data-screen="${item.label}" class="nav-item flex flex-col items-center justify-center w-1/5 pt-2 pb-1 transition-colors duration-200 ${activeScreen === item.label ? 'text-green-700' : 'text-gray-400 hover:text-green-600'}">
              ${item.icon}
              <span class="text-xs mt-1">${item.label}</span>
            </button>
          `).join('');
        }
      }

      function renderExploreContent() {
          const categoriesContainer = document.getElementById('categories-container');
          if (categoriesContainer && !categoriesContainer.hasChildNodes()) {
              categories.forEach(cat => {
                  const button = document.createElement('button');
                  button.textContent = cat;
                  button.className = `px-4 py-2 rounded-full text-sm font-semibold transition-colors whitespace-nowrap bg-white text-gray-700 border`;
                  button.onclick = () => {
                      // Update active category style and re-render destinations
                      document.querySelectorAll('#categories-container button').forEach(btn => btn.className = `px-4 py-2 rounded-full text-sm font-semibold transition-colors whitespace-nowrap bg-white text-gray-700 border`);
                      button.className = `px-4 py-2 rounded-full text-sm font-semibold transition-colors whitespace-nowrap bg-green-700 text-white`;
                      renderDestinations(cat);
                  };
                  categoriesContainer.appendChild(button);
              });
              // Set initial active category
              categoriesContainer.firstChild.className = `px-4 py-2 rounded-full text-sm font-semibold transition-colors whitespace-nowrap bg-green-700 text-white`;
          }
          renderMapWidget();
          renderDestinations('Todos');
      }
      
      function renderDestinations(category) {
        const listEl = document.getElementById('destinations-list');
        if (!listEl) return;
        const filtered = category === 'Todos' ? mockDestinations : mockDestinations.filter(d => d.category === category);
        
        const difficultyBadge = (difficulty) => {
            const colorMap = { Principiante: 'bg-green-500', Intermedio: 'bg-yellow-500', Avanzada: 'bg-red-500' };
            return `<span class="absolute top-2 right-2 text-xs font-bold px-2 py-1 rounded-full text-white ${colorMap[difficulty]}">${difficulty}</span>`;
        };
        
        listEl.innerHTML = filtered.map(dest => `
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden flex">
                <img src="${dest.imageUrl}" alt="${dest.name}" class="w-1/3 object-cover"/>
                <div class="p-4 flex flex-col justify-between w-2/3 relative">
                    ${difficultyBadge(dest.difficulty)}
                    <div>
                        <h4 class="font-bold text-gray-900">${dest.name}</h4>
                        <p class="text-xs text-gray-500 mt-1">${dest.description}</p>
                        <p class="text-xs text-gray-400 mt-2">${dest.altitude} m</p>
                    </div>
                    <button class="mt-3 w-full text-center px-3 py-1.5 border border-green-600 text-green-600 rounded-full text-xs font-semibold hover:bg-green-50 transition">+ Agregar a Checklist</button>
                </div>
            </div>
        `).join('');
      }

      function renderMapWidget() {
          const widgetEl = document.getElementById('map-widget');
          if (!widgetEl) return;

          let content = `<h3 class="text-lg font-bold text-gray-800">Mapa Interactivo</h3><p class="text-sm text-gray-500 mt-1 mb-3">Descubre lugares cercanos a ti.</p>`;

          if (locationError) {
              content += `<p class="text-xs text-red-500 mt-2">${locationError}</p>`;
          }
          
          if (userLocation) {
              content += `<div><p class="text-xs text-gray-600 text-center mb-2">Ubicación: ${userLocation.coords.latitude.toFixed(4)}, ${userLocation.coords.longitude.toFixed(4)}</p><div id="map-container" class="h-48 bg-gray-200 mt-2 rounded-lg overflow-hidden shadow-inner"></div></div>`;
          } else {
              content += `<button id="get-location-btn" class="flex items-center justify-center mx-auto px-4 py-2 bg-green-600 text-white rounded-full text-sm font-semibold hover:bg-green-700 transition">${MapPinIcon("w-4 h-4 mr-2")} Activar ubicación</button>`;
          }
          
          widgetEl.innerHTML = content;
          if (userLocation) {
              initMap();
          } else {
              document.getElementById('get-location-btn').onclick = handleGetLocation;
          }
      }

      // --- LOGIC & EVENT HANDLERS ---
      function handleLoginSuccess() {
        appState = 'loggedIn';
        activeScreen = 'Inicio';
        render();
      }

      function addOnboardingListeners() {
        document.getElementById('show-login-btn')?.addEventListener('click', () => { onboardingState.authMode = 'login'; renderOnboardingForm(); });
        document.getElementById('show-register-btn')?.addEventListener('click', () => { onboardingState.authMode = 'register'; renderOnboardingForm(); });
        document.getElementById('tab-login-btn')?.addEventListener('click', () => { onboardingState.authMode = 'login'; renderOnboardingForm(); });
        document.getElementById('tab-register-btn')?.addEventListener('click', () => { onboardingState.authMode = 'register'; renderOnboardingForm(); });
        document.getElementById('login-form')?.addEventListener('submit', (e) => { e.preventDefault(); handleLoginSuccess(); });
        document.getElementById('register-form')?.addEventListener('submit', (e) => { e.preventDefault(); handleLoginSuccess(); });
      }

      function addNavListeners() {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', () => {
            activeScreen = item.dataset.screen;
            renderBottomNav();
            renderActiveScreen();
            addNavListeners(); // Re-add listeners to the new nav
          });
        });
      }

      function handleGetLocation() {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                  (position) => {
                      userLocation = position;
                      locationError = null;
                      renderMapWidget();
                  },
                  (err) => {
                      locationError = `Error: ${err.message}`;
                      renderMapWidget();
                  }
              );
          } else {
              locationError = "La geolocalización no es soportada.";
              renderMapWidget();
          }
      }
      
      // --- MAPS API ---
      const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY_HERE'; // IMPORTANT: Replace with your actual key
      let isMapsScriptLoaded = false;
      
      function loadGoogleMapsScript(callback) {
        if (typeof google !== 'undefined' && google.maps) {
          callback();
          return;
        }
        if (document.getElementById('googleMapsScript')) {
            document.getElementById('googleMapsScript').addEventListener('load', callback);
            return;
        }
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}`;
        script.id = 'googleMapsScript';
        script.async = true;
        script.defer = true;
        script.onload = callback;
        script.onerror = () => console.error("Google Maps script could not be loaded.");
        document.head.appendChild(script);
      }
      
      function initMap() {
          if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY_HERE') {
              document.getElementById('map-container').innerHTML = '<div class="w-full h-full flex items-center justify-center bg-gray-100 text-center p-4"><p class="text-sm text-gray-600">La clave de API de Google Maps no está configurada.</p></div>';
              return;
          }

          loadGoogleMapsScript(() => {
              const mapContainer = document.getElementById('map-container');
              if (!mapContainer || !userLocation) return;

              const userCoords = { lat: userLocation.coords.latitude, lng: userLocation.coords.longitude };
              const map = new google.maps.Map(mapContainer, {
                  center: userCoords, zoom: 9, disableDefaultUI: true, zoomControl: true,
                  styles: [{featureType: "poi", stylers: [{ visibility: "off" }]}, {featureType: "transit", stylers: [{ visibility: "off" }]}]
              });
              
              new google.maps.Marker({
                  position: userCoords, map: map, title: "Tu ubicación",
                  icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
              });

              mockDestinations.forEach(dest => {
                  const destMarker = new google.maps.Marker({ position: { lat: dest.latitude, lng: dest.longitude }, map: map, title: dest.name });
                  const infowindow = new google.maps.InfoWindow({
                      content: `<div style="font-family: sans-serif; padding: 5px;"><h3 style="font-weight: bold; font-size: 1rem; margin: 0 0 4px;">${dest.name}</h3><p style="font-size: 0.8rem; color: #555; margin: 0;">${dest.description}</p><p style="font-size: 0.75rem; color: #888; margin: 4px 0 0;">${dest.altitude} m - ${dest.difficulty}</p></div>`
                  });
                  destMarker.addListener('click', () => infowindow.open({ anchor: destMarker, map }));
              });
          });
      }

      // --- INITIALIZATION ---
      document.addEventListener('DOMContentLoaded', () => {
        render(); // Initial render of splash screen
        
        setTimeout(() => {
          appState = 'onboarding';
          render();
          
          let imageInterval = setInterval(() => {
            onboardingState.currentImage = (onboardingState.currentImage + 1) % onboardingImages.length;
            const images = document.querySelectorAll('.onboarding-image');
            const dots = document.querySelectorAll('#onboarding-dots > div');
            images.forEach((img, idx) => {
              img.classList.toggle('opacity-100', idx === onboardingState.currentImage);
              img.classList.toggle('opacity-0', idx !== onboardingState.currentImage);
            });
            dots.forEach((dot, idx) => {
                dot.className = `w-2.5 h-2.5 rounded-full transition-all ${idx === onboardingState.currentImage ? 'bg-white scale-125' : 'bg-white/50'}`;
            });
          }, 4000);

        }, 2000);
      });
    </script>
</body>
</html>
